---
- name: Asserting if any ruby packages are installed via rvm
  command: '{{ rvm }} {{ item }} do true'
  with_items: rvm_rubies
  when: rvm_rubies
  changed_when: False
  failed_when: False
  register: detected_rubies

- name: Installing rubies
  command: '{{ rvm }} install {{ item.item }} {{ rvm_rubies_install_flags }}'
  when: rvm_rubies and item.rc|default(0) != 0
  with_items: detected_rubies.results
  sudo_user: '{{ rvm_user }}'

- name: Asserting which is the default ruby version
  command: '{{ rvm }} alias list default'
  changed_when: False
  register: detected_default_ruby_version

- name: Setting up the correct default ruby version
  command: '{{ rvm }} alias create default {{ rvm_default_ruby_version }}'
  when: detected_default_ruby_version.stdout|default() == '' or
        rvm_default_ruby_version not in detected_default_ruby_version.stdout

- name: Install bundler if not installed
  shell: '{{ rvm_gem_bin }} install bundler'
  args:
    creates: '{{ rvm_install_path }}/wrappers/{{ item.stdout }}/bundler'
  register: bundler_install
  changed_when: '"Successfully installed bundler" in bundler_install.stdout'

- name: Asserting if is there any ruby versions that to be deleted
  command: '{{ rvm }} {{ rvm_rubies_to_purge }} do true'
  changed_when: False
  failed_when: False
  register: detected_rubies_to_purge
  when: rvm_rubies_to_purge

- name: Purging ruby versions
  command: '{{ rvm }} remove {{ detected_rubies_to_purge }}'
  changed_when: False
  when: rvm_rubies_to_purge and detected_rubies_to_purge.rc == 0
